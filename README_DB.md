
# Configuração do Banco de Dados (Supabase)

Para utilizar o Supabase como backend, execute o seguinte script na aba **SQL Editor** do seu projeto Supabase.

Este script contém a estrutura completa para armazenar todos os dados do sistema: Clientes, Operações, Recebimentos (com observações) e Usuários.

```sql
-- 1. Limpeza Completa (Cuidado: Apaga todos os dados existentes para recriar a estrutura)
DROP TABLE IF EXISTS receipts CASCADE;
DROP TABLE IF EXISTS operations CASCADE;
DROP TABLE IF EXISTS clients CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- 2. Tabela de Usuários
CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  papel TEXT NOT NULL CHECK (papel IN ('Administrador', 'Operador', 'Analista')),
  password TEXT NOT NULL, -- Obs: Em um cenário real, integre com Supabase Auth
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 3. Tabela de Clientes
CREATE TABLE clients (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome TEXT NOT NULL,
  cpf_cnpj TEXT UNIQUE NOT NULL,
  email TEXT,
  telefone TEXT,
  endereco TEXT,
  limite_credito NUMERIC(15, 2) DEFAULT 0,
  taxa_juros_mensal NUMERIC(5, 2) DEFAULT 0,
  data_cadastro TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 4. Tabela de Operações (Relacionada a Clientes)
CREATE TABLE operations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  client_id BIGINT REFERENCES clients(id) ON DELETE CASCADE NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('duplicata', 'cheque')),
  title_number TEXT NOT NULL,
  nominal_value NUMERIC(15, 2) NOT NULL, -- Valor de face do título
  net_value NUMERIC(15, 2) NOT NULL,     -- Valor líquido (Nominal + Juros, conforme nova regra)
  issue_date DATE NOT NULL,
  due_date DATE NOT NULL,
  taxa NUMERIC(5, 2) NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('aberto', 'pago', 'atrasado')) DEFAULT 'aberto',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Índice para melhorar performance de buscas por cliente
CREATE INDEX idx_operations_client_id ON operations(client_id);

-- 5. Tabela de Recebimentos (Relacionada a Operações)
CREATE TABLE receipts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  operation_id BIGINT REFERENCES operations(id) ON DELETE CASCADE NOT NULL,
  data_recebimento DATE NOT NULL,
  valor_total_recebido NUMERIC(15, 2) NOT NULL,
  valor_principal_pago NUMERIC(15, 2) DEFAULT 0, -- Quanto abateu do principal
  valor_juros_pago NUMERIC(15, 2) DEFAULT 0,     -- Quanto foi pago de juros
  forma_pagamento TEXT NOT NULL CHECK (forma_pagamento IN ('pix', 'boleto', 'transferencia')),
  observacoes TEXT, -- Campo novo para anotações do recebimento
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Índice para melhorar performance de buscas de recebimentos por operação
CREATE INDEX idx_receipts_operation_id ON receipts(operation_id);

-- 6. Habilitar Segurança (RLS - Row Level Security)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE operations ENABLE ROW LEVEL SECURITY;
ALTER TABLE receipts ENABLE ROW LEVEL SECURITY;

-- 7. Criar Políticas de Acesso (Permitir leitura/escrita pública para facilitar o uso inicial)
-- Em produção, substitua 'true' por verificações de autenticação (ex: auth.uid() = user_id)
CREATE POLICY "Acesso total a users" ON users FOR ALL USING (true);
CREATE POLICY "Acesso total a clients" ON clients FOR ALL USING (true);
CREATE POLICY "Acesso total a operations" ON operations FOR ALL USING (true);
CREATE POLICY "Acesso total a receipts" ON receipts FOR ALL USING (true);

-- 8. Inserir Usuário Administrador Padrão
INSERT INTO users (nome, email, papel, password)
VALUES 
('Administrador', 'gestaocaribe@gmail.com', 'Administrador', 'gestaomichel10');

```

## Resumo das Tabelas e Campos

1.  **Users**: Autenticação simples e permissões.
2.  **Clients**: Cadastro completo, limite de crédito e taxa padrão.
3.  **Operations**: Títulos (cheques/duplicatas), valores calculados (Nominal + Taxa = Líquido), datas e status.
4.  **Receipts**: Baixas parciais ou totais, discriminação entre Principal/Juros e campo de Observações.
