
# Configuração do Banco de Dados (Supabase)

Para utilizar o Supabase como backend, execute o seguinte script na aba **SQL Editor** do seu projeto Supabase.

Este script contém a estrutura completa para armazenar todos os dados do sistema, com campos opcionais para maior flexibilidade.

```sql
-- 1. Limpeza Completa (Cuidado: Apaga todos os dados existentes para recriar a estrutura)
DROP TABLE IF EXISTS receipts CASCADE;
DROP TABLE IF EXISTS operations CASCADE;
DROP TABLE IF EXISTS clients CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- 2. Tabela de Usuários (Mantive NOT NULL no email/senha por segurança lógica, mas pode ser removido se desejar)
CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome TEXT,
  email TEXT UNIQUE,
  papel TEXT CHECK (papel IN ('Administrador', 'Operador', 'Analista')),
  password TEXT, 
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 3. Tabela de Clientes (Sem NOT NULL e sem UNIQUE obrigatório no CPF/CNPJ para permitir vazios)
CREATE TABLE clients (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome TEXT,
  cpf_cnpj TEXT, -- Removido UNIQUE para evitar erro ao inserir vários vazios
  email TEXT,
  telefone TEXT,
  endereco TEXT,
  limite_credito NUMERIC(15, 2) DEFAULT 0,
  taxa_juros_mensal NUMERIC(5, 2) DEFAULT 0,
  data_cadastro TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 4. Tabela de Operações
CREATE TABLE operations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  client_id BIGINT REFERENCES clients(id) ON DELETE SET NULL, -- Permite operação sem cliente (NULL)
  type TEXT CHECK (type IN ('duplicata', 'cheque', 'parcelamento')),
  title_number TEXT,
  nominal_value NUMERIC(15, 2),
  net_value NUMERIC(15, 2),
  issue_date DATE,
  due_date DATE,
  taxa NUMERIC(5, 2),
  status TEXT CHECK (status IN ('aberto', 'pago', 'atrasado')) DEFAULT 'aberto',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Índice
CREATE INDEX idx_operations_client_id ON operations(client_id);

-- 5. Tabela de Recebimentos
CREATE TABLE receipts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  operation_id BIGINT REFERENCES operations(id) ON DELETE CASCADE,
  data_recebimento DATE,
  valor_total_recebido NUMERIC(15, 2),
  valor_principal_pago NUMERIC(15, 2) DEFAULT 0,
  valor_juros_pago NUMERIC(15, 2) DEFAULT 0,
  forma_pagamento TEXT CHECK (forma_pagamento IN ('pix', 'boleto', 'transferencia')),
  observacoes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Índice
CREATE INDEX idx_receipts_operation_id ON receipts(operation_id);

-- 6. Habilitar Segurança (RLS - Row Level Security)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE operations ENABLE ROW LEVEL SECURITY;
ALTER TABLE receipts ENABLE ROW LEVEL SECURITY;

-- 7. Criar Políticas de Acesso (Permitir leitura/escrita pública)
CREATE POLICY "Acesso total a users" ON users FOR ALL USING (true);
CREATE POLICY "Acesso total a clients" ON clients FOR ALL USING (true);
CREATE POLICY "Acesso total a operations" ON operations FOR ALL USING (true);
CREATE POLICY "Acesso total a receipts" ON receipts FOR ALL USING (true);

-- 8. Inserir Usuário Administrador Padrão
INSERT INTO users (nome, email, papel, password)
VALUES 
('Administrador', 'gestaocaribe@gmail.com', 'Administrador', 'gestaomichel10');
```
